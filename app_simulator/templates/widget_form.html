{% extends "base.html" %}

{% block content %}
<div class="container" id="full-container">
  <div class="card">
    <div class="card-header">Preview App</div>
    <div class="card-body">
    {% if exceptions %}
      <h5>Validation Error</h5>
      <br>
      {% for error in exceptions %}
        {% if error.error %}
          <div class="alert alert-danger">{{ error.error }}</div>
        {% else %}
          <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
      {% endfor %}
    {% else %}
      {% if warnings.get("missing_loadsdk") %}
        <div class="alert alert-warning" role="alert">
          Make sure you include a <code>{% raw %}{{ __loadsdk__ }}{% endraw %}</code> directive in your template. From February 2023 onwards, it will be required in all Apps.
        </div>
      {% endif %}
      <h5>App Info</h5>
      <p><strong>Name :</strong><br>{{ title }}</p>
      {% if description %}<p><strong>Description :</strong><br>{{ description }}</p>{% endif %}
      {% if kind %}<p><strong>Kind :</strong><br>{{ kind }}</p>{% endif %}
      <form action="{{ file_name }}" method="POST" enctype="multipart/form-data">
      {% if has_attributes %}
        <hr>
        <h5>App Attributes</h5>
        <small class="form-text text-muted">Check the <a href="https://github.com/onsigntv/apps/tree/master/docs/ATTRS.md">App Attributes API documentation</a> for how to declare and access attributes.</small>
        <p class="form-text text-muted">This app contains attributes that are connected to the following player attributes. The user will have to choose which player attributes to connect to.</p>
      {% endif %}
      {% set optsection = namespace(is_open=false) %}
      {% for field in form -%}
        {% if field.label.field_id == "_delay_show" %}
          {% set optsection.is_open = True %}
          <hr>
          <h5>Simulator Options</h5>
        {% endif %}
        {% if not field.is_attribute and not optsection.is_open %}
          {% set optsection.is_open = True %}
          <hr>
          <h5>App Options</h5>
          <p class="form-text text-muted">The user of this app will be able to configure the following options.</p>
        {% endif %}
        {% if field.widget.input_type == "checkbox" -%}
        <div class="form-check" style="margin-bottom: 1rem;">
          {{ field() }}
          <label class="form-check-label" for="{{ field.label.field_id }}">{{ field.label.text }}</label>
        {% else -%}
        <div class="form-group">
          <label for="{{ field.label.field_id }}" {% if field.is_attribute %}style="margin-bottom: auto"{% endif %}>
            {% if field.is_attribute and not field.required %}
              <input data-attr="{{ field.label.field_id }}" data-label="{{ field.label.text }}" class="connect-attr form-check-label" type="checkbox" checked="true">
            {% endif %}
            {{ field.label.text }}
            {% if field.flags.required %}<small class="align-top"><strong>[required]</strong></small>{% endif %}
          </label>
          {% if field.label.field_id == "_playback_info" %}
            &nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-light btn-sm" id="pbInfoBtn">edit</button>
          {% endif %}
          {{ field() }}
        {% endif -%}
          {% for error in field.errors -%}
            <div class="invalid-feedback">{{ error }}</div>
          {% endfor -%}
          {% if field.description -%}
            <small class="form-text text-muted">{{ field.description }}</small>
          {% endif -%}
        </div>
      {% endfor %}
        <hr>
        <button type="submit" class="btn btn-primary"> Preview </button>
      </form>
    {% endif %}
    </div>
  </div>
</div>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    var button = document.getElementById("pbInfoBtn");
    function togglePlaybackInfo () {
      var toggled = document.getElementById("_playback_info").toggleAttribute("hidden");
      if (toggled) {
        button.innerHTML = "edit";
      } else {
        button.innerHTML = "done";
      }
    }
    button.addEventListener("click", togglePlaybackInfo, false);
    togglePlaybackInfo();

    function toggleAttrConnection(checkbox) {
      var textArea = document.getElementById("_playback_info");
      var pbInfo = JSON.parse(textArea.value);

      if (checkbox.checked) {
        pbInfo.player.attrs[checkbox.dataset.label] = null;
      } else {
        delete pbInfo.player.attrs[checkbox.dataset.label];
      }

      var defaultValueInput = document.getElementById(checkbox.dataset.attr);
      if (defaultValueInput) {
        defaultValueInput.hidden = !checkbox.checked;
        if (!checkbox.checked) defaultValueInput.value = null;
      }

      textArea.value = JSON.stringify(pbInfo, null, 2);
    }

    Array.from(document.getElementsByClassName("connect-attr")).forEach(function(checkbox) {
      checkbox.addEventListener("click", function() {
        toggleAttrConnection(this);
      });

      toggleAttrConnection(checkbox);
    });
  }, false);

</script>

{% endblock %}
